-- v4_content_management.sql
-- ูุธุงู ุฅุฏุงุฑุฉ ุงููุญุชูู

BEGIN;

-- ุฌุฏูู ููุทุงุช ุงููุญุชูู
CREATE TABLE IF NOT EXISTS content_snapshots (
    id SERIAL PRIMARY KEY,
    locale VARCHAR(10) NOT NULL CHECK (locale IN ('ar', 'en')),
    content JSONB NOT NULL,
    version INTEGER DEFAULT 1,
    created_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_published BOOLEAN DEFAULT false,
    published_at TIMESTAMP WITH TIME ZONE
);

-- ุฌุฏูู ุณุฌู ูุดุฑ ุงููุญุชูู
CREATE TABLE IF NOT EXISTS content_publish_history (
    id SERIAL PRIMARY KEY,
    snapshot_id INTEGER REFERENCES content_snapshots(id) ON DELETE CASCADE,
    published_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
    published_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    locale VARCHAR(10) NOT NULL CHECK (locale IN ('ar', 'en')),
    version INTEGER NOT NULL,
    notes TEXT
);

-- ุฏุงูุฉ ูุฅูุดุงุก ููุทุฉ ูุญุชูู ุฌุฏูุฏุฉ
CREATE OR REPLACE FUNCTION create_content_snapshot(
    p_locale VARCHAR(10),
    p_content JSONB,
    p_user_id INTEGER,
    p_publish BOOLEAN DEFAULT false
) RETURNS INTEGER AS $$
DECLARE
    v_last_version INTEGER;
    v_new_id INTEGER;
BEGIN
    -- ุงูุญุตูู ุนูู ุขุฎุฑ ุฅุตุฏุงุฑ
    SELECT COALESCE(MAX(version), 0) INTO v_last_version
    FROM content_snapshots
    WHERE locale = p_locale;
    
    -- ุฅูุดุงุก ููุทุฉ ุฌุฏูุฏุฉ
    INSERT INTO content_snapshots (
        locale,
        content,
        version,
        created_by,
        is_published,
        published_at
    ) VALUES (
        p_locale,
        p_content,
        v_last_version + 1,
        p_user_id,
        p_publish,
        CASE WHEN p_publish THEN NOW() ELSE NULL END
    ) RETURNING id INTO v_new_id;
    
    -- ุฅุฐุง ูุงู ุงููุดุฑ ูุทููุจุงูุ ูู ุจุชุญุฏูุซ ุณุฌู ุงููุดุฑ
    IF p_publish THEN
        INSERT INTO content_publish_history (
            snapshot_id,
            published_by,
            locale,
            version,
            notes
        ) VALUES (
            v_new_id,
            p_user_id,
            p_locale,
            v_last_version + 1,
            'ูุดุฑ ุชููุงุฆู ุนูุฏ ุงูุฅูุดุงุก'
        );
        
        -- ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ุจุงููุญุชูู ุงูููุดูุฑ
        PERFORM update_published_content();
    END IF;
    
    RETURN v_new_id;
END;
$$ LANGUAGE plpgsql;

-- ุฏุงูุฉ ููุดุฑ ููุทุฉ ูุญุชูู
CREATE OR REPLACE FUNCTION publish_content_snapshot(
    p_snapshot_id INTEGER,
    p_user_id INTEGER,
    p_notes TEXT DEFAULT NULL
) RETURNS BOOLEAN AS $$
DECLARE
    v_locale VARCHAR(10);
    v_version INTEGER;
BEGIN
    -- ุงูุญุตูู ุนูู ูุนูููุงุช ุงูููุทุฉ
    SELECT locale, version INTO v_locale, v_version
    FROM content_snapshots
    WHERE id = p_snapshot_id;
    
    IF NOT FOUND THEN
        RETURN false;
    END IF;
    
    -- ุชุญุฏูุซ ุญุงูุฉ ุงููุดุฑ ูููุทุฉ
    UPDATE content_snapshots
    SET is_published = true,
        published_at = NOW()
    WHERE id = p_snapshot_id;
    
    -- ุฅูุบุงุก ูุดุฑ ุงูููุทุงุช ุงูุฃุฎุฑู ุจููุณ ุงููุบุฉ
    UPDATE content_snapshots
    SET is_published = false
    WHERE locale = v_locale
      AND id != p_snapshot_id
      AND is_published = true;
    
    -- ุฅุถุงูุฉ ุณุฌู ุงููุดุฑ
    INSERT INTO content_publish_history (
        snapshot_id,
        published_by,
        locale,
        version,
        notes
    ) VALUES (
        p_snapshot_id,
        p_user_id,
        v_locale,
        v_version,
        COALESCE(p_notes, 'ูุดุฑ ูุญุชูู')
    );
    
    -- ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ุจุงููุญุชูู ุงูููุดูุฑ
    PERFORM update_published_content();
    
    RETURN true;
END;
$$ LANGUAGE plpgsql;

-- ุฏุงูุฉ ูุชุญุฏูุซ ุงููุญุชูู ุงูููุดูุฑ ูู ุงูุฅุนุฏุงุฏุงุช
CREATE OR REPLACE FUNCTION update_published_content() RETURNS VOID AS $$
DECLARE
    v_ar_content JSONB;
    v_en_content JSONB;
    v_design JSONB;
BEGIN
    -- ุงูุญุตูู ุนูู ุงููุญุชูู ุงูุนุฑุจู ุงูููุดูุฑ
    SELECT content INTO v_ar_content
    FROM content_snapshots
    WHERE locale = 'ar' AND is_published = true
    ORDER BY published_at DESC
    LIMIT 1;
    
    -- ุงูุญุตูู ุนูู ุงููุญุชูู ุงูุฅูุฌููุฒู ุงูููุดูุฑ
    SELECT content INTO v_en_content
    FROM content_snapshots
    WHERE locale = 'en' AND is_published = true
    ORDER BY published_at DESC
    LIMIT 1;
    
    -- ุงูุญุตูู ุนูู ุชุตููู ุงููููุน
    SELECT value INTO v_design
    FROM settings
    WHERE key = 'site_design';
    
    -- ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช
    UPDATE settings
    SET value = jsonb_build_object(
        'ar', COALESCE(v_ar_content, '{}'::jsonb),
        'en', COALESCE(v_en_content, '{}'::jsonb),
        'design', COALESCE(v_design, '{}'::jsonb)
    )
    WHERE key = 'published_content';
    
    -- ุฅุฐุง ูู ููู ุงูุฅุนุฏุงุฏ ููุฌูุฏุงูุ ูู ุจุฅูุดุงุฆู
    IF NOT FOUND THEN
        INSERT INTO settings (key, value, description)
        VALUES (
            'published_content',
            jsonb_build_object(
                'ar', COALESCE(v_ar_content, '{}'::jsonb),
                'en', COALESCE(v_en_content, '{}'::jsonb),
                'design', COALESCE(v_design, '{}'::jsonb)
            ),
            'ุงููุญุชูู ุงูููุดูุฑ ุญุงููุงู'
        );
    END IF;
END;
$$ LANGUAGE plpgsql;

-- ุฅูุดุงุก ููุงุฑุณ ููุฃุฏุงุก
CREATE INDEX IF NOT EXISTS idx_content_snapshots_locale ON content_snapshots(locale);
CREATE INDEX IF NOT EXISTS idx_content_snapshots_published ON content_snapshots(is_published);
CREATE INDEX IF NOT EXISTS idx_content_snapshots_version ON content_snapshots(version);
CREATE INDEX IF NOT EXISTS idx_content_publish_history_snapshot_id ON content_publish_history(snapshot_id);
CREATE INDEX IF NOT EXISTS idx_content_publish_history_locale ON content_publish_history(locale);

-- ุฅุถุงูุฉ ูุญุชูู ุงูุชุฑุงุถู ุฅุฐุง ูู ููู ููุฌูุฏุงู
DO $$
DECLARE
    v_ar_exists BOOLEAN;
    v_en_exists BOOLEAN;
    v_admin_id INTEGER;
BEGIN
    -- ุงูุชุญูู ูู ูุฌูุฏ ูุญุชูู ููุดูุฑ
    SELECT EXISTS (
        SELECT 1 FROM content_snapshots WHERE locale = 'ar' AND is_published = true
    ) INTO v_ar_exists;
    
    SELECT EXISTS (
        SELECT 1 FROM content_snapshots WHERE locale = 'en' AND is_published = true
    ) INTO v_en_exists;
    
    -- ุงูุญุตูู ุนูู ูุนุฑู ุงููุณุชุฎุฏู ุงููุณุคูู
    SELECT id INTO v_admin_id FROM users WHERE role = 'admin' ORDER BY id LIMIT 1;
    
    -- ุฅุฐุง ูู ููู ููุงู ูุณุชุฎุฏู ูุณุคููุ ูู ุจุฅูุดุงุก ูุงุญุฏ
    IF v_admin_id IS NULL THEN
        INSERT INTO users (name, email, role, active)
        VALUES ('ุงููุฏูุฑ ุงูุนุงู', 'admin@kyctrust.com', 'admin', true)
        RETURNING id INTO v_admin_id;
    END IF;
    
    -- ุฅูุดุงุก ูุญุชูู ุงูุชุฑุงุถู ููุบุฉ ุงูุนุฑุจูุฉ ุฅุฐุง ูู ููู ููุฌูุฏุงู
    IF NOT v_ar_exists THEN
        PERFORM create_content_snapshot(
            'ar',
            '{"site":{"name":"KYCtrust","description":"ุฎุฏูุฉ ูุชุฎุตุตุฉ ูู ุงูุญุณุงุจุงุช ุงูุจูููุฉ ุงูุฅููุชุฑูููุฉ ูุงูุฎุฏูุงุช ุงููุงููุฉ ุงูุขููุฉ","phone":"+20-106-245-3344","tagline":"ุดุฑููู ุงูููุซูู ูู ุงูุนุงูู ุงูุฑููู"},"hero":{"title":"KYCtrust","subtitle":"ููุตุฉ ูุชูุงููุฉ ููุฎุฏูุงุช ุงููุงููุฉ ุงูุฑูููุฉ","description":"ุงุญุตู ุนูู ุฃูุถู ุงูุญุณุงุจุงุช ุงูุจูููุฉ ุงูุฅููุชุฑูููุฉ ูุงููุญุงูุธ ุงูุฑูููุฉ ุจุฃูุงู ูุณุฑุนุฉ ูุง ูุซูู ููุง","cta":"ุงุจุฏุฃ ุฑุญูุชู ุงููุงููุฉ","secondary":"ุชุตูุญ ุฎุฏูุงุชูุง","stats":[{"number":"1000+","label":"ุนููู ุฑุงุถู"},{"number":"24/7","label":"ุฏุนู ููู"},{"number":"99.9%","label":"ูุนุฏู ุงููุฌุงุญ"},{"number":"15+","label":"ุฎุฏูุฉ ูุชุงุญุฉ"}]},"services":[{"name":"Payoneer","price":"$30","category":"ุญุณุงุจุงุช ุจูููุฉ","icon":"๐ณ","popular":true,"active":true,"sort":1,"description":"ุญุณุงุจ ุจููู ุนุงููู ููุซูู"},{"name":"Wise","price":"$30","category":"ุญุณุงุจุงุช ุจูููุฉ","icon":"๐ฆ","popular":true,"active":true,"sort":2,"description":"ุชุญูููุงุช ุฏูููุฉ ุจุฃูู ุฑุณูู"},{"name":"Skrill","price":"$20","category":"ูุญุงูุธ ุฅููุชุฑูููุฉ","icon":"๐ฐ","active":true,"sort":3,"description":"ูุญูุธุฉ ุฅููุชุฑูููุฉ ุขููุฉ ูุณุฑูุนุฉ"},{"name":"Neteller","price":"$20","category":"ูุญุงูุธ ุฅููุชุฑูููุฉ","icon":"๐ธ","active":true,"sort":4,"description":"ูุฏููุนุงุช ููุฑูุฉ ุนุงูููุง"},{"name":"PayPal","price":"$15","category":"ูุญุงูุธ ุฅููุชุฑูููุฉ","icon":"๐","popular":true,"active":true,"sort":12,"description":"ุงูุญู ุงูุฃุดูุฑ ูููุฏููุนุงุช"}],"payments":[{"label":"ููุฏุงููู ูุงุด","value":"01062453344","icon":"๐ฑ","color":"red"},{"label":"USDT TRC20","value":"TFUt8GRpk2R8Wv3FvoCiSUghRBQo4HrmQK","icon":"โฟ","color":"green"}],"features":[{"title":"ุฎุฏูุฉ ุณุฑูุนุฉ","desc":"ุชุณููู ุฎูุงู 24-48 ุณุงุนุฉ","icon":"โก"},{"title":"ุฃูุงู ูุถููู","desc":"ุญูุงูุฉ ูุงููุฉ ูุจูุงูุงุชู","icon":"๐"},{"title":"ุฏุนู ูุณุชูุฑ","desc":"ูุฑูู ุฏุนู ุนูู ูุฏุงุฑ ุงูุณุงุนุฉ","icon":"๐๏ธ"},{"title":"ุฃุณุนุงุฑ ุชูุงูุณูุฉ","desc":"ุฃูุถู ุงูุฃุณุนุงุฑ ูู ุงูุณูู","icon":"๐ฐ"}],"faq":[{"question":"ูู ุชุณุชุบุฑู ุนูููุฉ ุฅูุดุงุก ุงูุญุณุงุจุ","answer":"ุนุงุฏุฉ ูู 24-48 ุณุงุนุฉ ุญุณุจ ููุน ุงูุญุณุงุจ ูุงููุชุทูุจุงุช. ูุญู ูุนูู ุจุฃูุตู ุณุฑุนุฉ ูุถูุงู ุญุตููู ุนูู ุญุณุงุจู ูู ุฃุณุฑุน ููุช ูููู."},{"question":"ูู ุงูุฎุฏูุฉ ุขููุฉ ููุถูููุฉุ","answer":"ูุนู ุชูุงูุงูุ ูุชุจุน ุฃุนูู ูุนุงููุฑ ุงูุฃูุงู ุงูุนุงูููุฉ ููุญุงูุธ ุนูู ุณุฑูุฉ ุจูุงูุงุชู ุงูุดุฎุตูุฉ. ููุง ููุฏู ุถูุงู ุงุณุชุฑุฏุงุฏ ุงููุงู ูู ุญุงูุฉ ุนุฏู ูุฌุงุญ ุงูุนูููุฉ."},{"question":"ูุง ูู ุทุฑู ุงูุฏูุน ุงููุชุงุญุฉุ","answer":"ููุจู ุงูุฏูุน ุนุจุฑ ููุฏุงููู ูุงุด ูุงูุนููุงุช ุงูุฑูููุฉ USDT TRC20 ููุท ูุถูุงู ุงูุฃูุงู ูุงูุณุฑุนุฉ ูู ุงููุนุงููุงุช."},{"question":"ูู ุชูุฏููู ุฎุฏูุฉ ูุง ุจุนุฏ ุงูุจูุนุ","answer":"ุจุงูุทุจุนุ ููุฏู ุฏุนู ููู ูุฌุงูู ูุฏู ุงูุญูุงุฉ ูุฌููุน ุนููุงุฆูุง ูุน ุฅุฑุดุงุฏุงุช ููุตูุฉ ูุงุณุชุฎุฏุงู ุญุณุงุจุงุชูู ุงูุฌุฏูุฏุฉ."}],"contact":{"title":"ุงุจุฏุฃ ูุนูุง ุงูููู","subtitle":"ูุฑูู ุงูุฏุนู ูุชุงุญ ุนูู ูุฏุงุฑ ุงูุณุงุนุฉ ููุฅุฌุงุจุฉ ุนูู ุงุณุชูุณุงุฑุงุชู","whatsapp":"ุชูุงุตู ุนุจุฑ ูุงุชุณุงุจ","features":["ุฑุฏ ููุฑู","ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ","ุถูุงู ุงูุฎุฏูุฉ"]}}',
            v_admin_id,
            true
        );
    END IF;
    
    -- ุฅูุดุงุก ูุญุชูู ุงูุชุฑุงุถู ููุบุฉ ุงูุฅูุฌููุฒูุฉ ุฅุฐุง ูู ููู ููุฌูุฏุงู
    IF NOT v_en_exists THEN
        PERFORM create_content_snapshot(
            'en',
            '{"site":{"name":"KYCtrust","description":"Specialized service for secure electronic banking accounts and financial services","phone":"+20-106-245-3344","tagline":"Your trusted partner in the digital world"},"hero":{"title":"KYCtrust","subtitle":"Complete Digital Financial Services Platform","description":"Get the best electronic banking accounts and digital wallets with unmatched security and speed","cta":"Start Your Financial Journey","secondary":"Browse Our Services","stats":[{"number":"1000+","label":"Happy Clients"},{"number":"24/7","label":"Support"},{"number":"99.9%","label":"Success Rate"},{"number":"15+","label":"Services"}]},"services":[{"name":"Payoneer","price":"$30","category":"Banking","icon":"๐ณ","popular":true,"active":true,"sort":1,"description":"Trusted global banking account"},{"name":"Wise","price":"$30","category":"Banking","icon":"๐ฆ","popular":true,"active":true,"sort":2,"description":"International transfers with lowest fees"},{"name":"Skrill","price":"$20","category":"E-Wallets","icon":"๐ฐ","active":true,"sort":3,"description":"Safe and fast digital wallet"},{"name":"Neteller","price":"$20","category":"E-Wallets","icon":"๐ธ","active":true,"sort":4,"description":"Instant payments worldwide"},{"name":"PayPal","price":"$15","category":"E-Wallets","icon":"๐","popular":true,"active":true,"sort":12,"description":"Most popular payment solution"}],"payments":[{"label":"Vodafone Cash","value":"01062453344","icon":"๐ฑ","color":"red"},{"label":"USDT TRC20","value":"TFUt8GRpk2R8Wv3FvoCiSUghRBQo4HrmQK","icon":"โฟ","color":"green"}],"features":[{"title":"Fast Service","desc":"Delivery within 24-48 hours","icon":"โก"},{"title":"Guaranteed Security","desc":"Complete protection for your data","icon":"๐"},{"title":"Continuous Support","desc":"24/7 support team","icon":"๐๏ธ"},{"title":"Competitive Prices","desc":"Best prices in the market","icon":"๐ฐ"}],"faq":[{"question":"How long does account creation take?","answer":"Usually 24-48 hours depending on account type and requirements. We work at maximum speed to ensure you get your account as soon as possible."},{"question":"Is the service safe and guaranteed?","answer":"Absolutely yes, we follow the highest international security standards and maintain confidentiality of your personal data. We also offer money-back guarantee if the process fails."},{"question":"What payment methods are available?","answer":"We accept payments via Vodafone Cash and USDT TRC20 cryptocurrency only to ensure security and speed in transactions."},{"question":"Do you provide after-sales service?","answer":"Of course, we provide free lifetime technical support for all our clients with detailed instructions for using your new accounts."}],"contact":{"title":"Get Started Today","subtitle":"Support team available 24/7 to answer your questions","whatsapp":"Contact via WhatsApp","features":["Instant Reply","Free Consultation","Service Guarantee"]}}',
            v_admin_id,
            true
        );
    END IF;
    
    -- ุชุญุฏูุซ ุชุตููู ุงููููุน
    UPDATE settings
    SET value = '{"theme":"system","palette":"emerald","layout":"default","animation":true,"rtl":true}'
    WHERE key = 'site_design';
    
    IF NOT FOUND THEN
        INSERT INTO settings (key, value, description)
        VALUES (
            'site_design',
            '{"theme":"system","palette":"emerald","layout":"default","animation":true,"rtl":true}',
            'ุฅุนุฏุงุฏุงุช ุชุตููู ุงููููุน'
        );
    END IF;
    
    -- ุชุญุฏูุซ ุงููุญุชูู ุงูููุดูุฑ
    PERFORM update_published_content();
END $$;

COMMIT;
